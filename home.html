<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CapNex | Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --bg-black: #050505;
            --card-dark: #121214;
            --primary-red: #FF3B30;
            --accent-yellow: #FFD60A;
            --text-main: #FFFFFF;
            --text-muted: #8E8E93;
            --glass-border: rgba(255, 255, 255, 0.05);
            --success: #34C759;
            --danger: #FF3B30;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            background: var(--bg-black); 
            color: var(--text-main); 
            padding-bottom: 110px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- ESTILIZA√á√ÉO DO POPUP DE BOAS-VINDAS E GERAL (PREMIUM CAPNEX RED) --- */
        .capnex-swal-popup {
            background: #121214 !important;
            border: 1px solid rgba(255, 59, 48, 0.2) !important;
            border-radius: 28px !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        .capnex-swal-title {
            color: #ffffff !important;
            font-weight: 800 !important;
            font-size: 1.4rem !important;
            letter-spacing: -0.5px;
            margin-top: 20px !important;
        }

        .capnex-swal-content {
            color: #8E8E93 !important;
            font-size: 0.95rem !important;
            padding: 0 20px 20px !important;
        }

        .capnex-swal-confirm {
            background: linear-gradient(90deg, #FF3B30, #8B0000) !important;
            color: #fff !important;
            font-weight: 800 !important;
            font-size: 1rem !important;
            width: 85% !important;
            margin: 10px auto 25px !important;
            border-radius: 14px !important;
            padding: 16px !important;
            text-transform: uppercase;
            box-shadow: 0 8px 25px rgba(255, 59, 48, 0.3) !important;
            border: none !important;
            cursor: pointer;
        }

        .capnex-swal-toast {
            background: #1c1c1e !important;
            border: 1px solid rgba(255, 59, 48, 0.3) !important;
            border-radius: 16px !important;
            color: #fff !important;
        }

        /* --- ELEMENTOS DO MODAL DE BOAS VINDAS --- */
        .welcome-header-img {
            width: 100%;
            height: 130px;
            background: linear-gradient(135deg, #FF3B30 0%, #8B0000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .welcome-header-img i {
            font-size: 4rem;
            color: #fff;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.4));
        }

        .welcome-body {
            padding: 25px 25px 10px;
            text-align: left;
        }

        .welcome-title-text {
            color: #fff;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        .welcome-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 25px;
            display: block;
            font-weight: 500;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-icon-box {
            min-width: 38px;
            height: 38px;
            background: rgba(255, 59, 48, 0.1);
            color: var(--primary-red);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .info-text-box h5 {
            color: #fff;
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-text-box p {
            color: var(--text-muted);
            font-size: 0.78rem;
            line-height: 1.4;
            margin: 0;
        }

        .info-text-box strong {
            color: var(--primary-red);
        }

        /* --- DASHBOARD UI --- */
        .grow-reveal {
            opacity: 0;
            transform: translateY(25px);
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .grow-reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        .header-top {
            padding: 30px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,59,48,0.08) 0%, rgba(5,5,5,0) 100%);
        }

        .user-meta span {
            display: block;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-meta h2 {
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-red), #8B0000);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .wallet-container {
            margin: 0 20px 25px;
            background: var(--accent-yellow);
            border-radius: 32px;
            padding: 30px 25px;
            color: #000;
            position: relative;
            box-shadow: 0 20px 40px rgba(255, 214, 10, 0.15);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .wallet-header label {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.7;
        }

        .eye-btn {
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
        }

        .balance-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .balance-item {
            background: rgba(0, 0, 0, 0.06);
            padding: 18px;
            border-radius: 22px;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .balance-item small {
            display: block;
            font-size: 0.65rem;
            font-weight: 800;
            margin-bottom: 8px;
            text-transform: uppercase;
            color: rgba(0,0,0,0.5);
        }

        .balance-item strong {
            font-size: 1.15rem;
            font-weight: 900;
            display: block;
        }

        .quick-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 0 20px 30px;
        }

        .nav-card {
            background: var(--card-dark);
            border: 1px solid var(--glass-border);
            padding: 22px 5px;
            border-radius: 26px;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-card:active { transform: scale(0.92); }

        .nav-card i {
            display: block;
            font-size: 1.4rem;
            margin-bottom: 12px;
        }

        .nav-card.dep i { color: var(--success); }
        .nav-card.wit i { color: var(--danger); }
        .nav-card.his i { color: #007AFF; }
        .nav-card.rew i { color: var(--accent-yellow); }

        .nav-card span {
            font-size: 0.65rem;
            font-weight: 800;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invite-section {
            background: var(--card-dark);
            margin: 0 20px 25px;
            padding: 22px;
            border-radius: 26px;
            border: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invite-info h4 { font-size: 1rem; font-weight: 800; margin-bottom: 4px; }
        .invite-info p { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        .btn-copy {
            background: rgba(255, 59, 48, 0.1);
            color: var(--primary-red);
            padding: 12px 18px;
            border-radius: 14px;
            font-size: 0.8rem;
            font-weight: 800;
            border: 1px solid rgba(255, 59, 48, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .banners-grid {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .banner {
            padding: 25px;
            border-radius: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-decoration: none;
            color: white;
            transition: 0.3s;
        }

        .banner.yield { background: linear-gradient(90deg, #FF7A00, #FF3D00); }
        .banner.plans { background: linear-gradient(90deg, #6A11CB, #2575FC); }

        .banner-content h3 { font-size: 1.1rem; font-weight: 900; margin-bottom: 5px; }
        .banner-content p { font-size: 0.8rem; font-weight: 600; opacity: 0.9; }

        .banner-icon {
            background: rgba(255,255,255,0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .transactions-area {
            margin-top: 35px;
            padding: 0 20px;
        }

        .area-title {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }

        .transaction-list {
            background: var(--card-dark);
            border-radius: 26px;
            padding: 10px 20px;
            border: 1px solid var(--glass-border);
            min-height: 50px;
        }

        .t-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .t-item:last-child { border-bottom: none; }
        .t-info h5 { font-size: 0.85rem; font-weight: 800; margin-bottom: 2px; }
        .t-info small { color: var(--text-muted); font-size: 0.7rem; font-weight: 600; }
        .t-amount { font-weight: 900; font-size: 0.95rem; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0D0D0F;
            display: flex;
            justify-content: space-around;
            padding: 15px 10px 30px;
            border-top: 1px solid var(--glass-border);
            z-index: 1000;
            backdrop-filter: blur(15px);
        }

        .nav-link {
            text-align: center;
            color: var(--text-muted);
            text-decoration: none;
            flex: 1;
            transition: 0.3s;
        }

        .nav-link i { display: block; font-size: 1.4rem; margin-bottom: 6px; }
        .nav-link span { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        .nav-link.active { color: var(--primary-red); }
    </style>
</head>
<body>

    <header class="header-top grow-reveal">
        <div class="user-meta">
            <span id="txt-greeting">Ol√°</span>
            <h2 id="user-display-name">Carregando...</h2>
        </div>
        <div class="profile-avatar" id="user-initials">--</div>
    </header>

    <section class="wallet-container grow-reveal">
        <div class="wallet-header">
            <label>Patrim√¥nio Total</label>
            <i class="fa-regular fa-eye eye-btn" id="btn-toggle-val"></i>
        </div>
        <div class="balance-main">
            <div class="balance-item">
                <small><i class="fa-solid fa-wallet"></i> Banc√°rio</small>
                <strong id="val-bancario">R$ 0,00</strong>
            </div>
            <div class="balance-item">
                <small><i class="fa-solid fa-chart-line"></i> Lucros</small>
                <strong id="val-lucro">R$ 0,00</strong>
            </div>
        </div>
    </section>

    <nav class="quick-nav">
        <a href="deposito.html" class="nav-card dep grow-reveal">
            <i class="fa-solid fa-circle-arrow-down"></i>
            <span>Depositar</span>
        </a>
        <a href="saque.html" class="nav-card wit grow-reveal">
            <i class="fa-solid fa-circle-arrow-up"></i>
            <span>Sacar</span>
        </a>
        <a href="recompensas.html" class="nav-card rew grow-reveal">
            <i class="fa-solid fa-gift"></i>
            <span>Pr√™mios</span>
        </a>
        <a href="transacoes.html" class="nav-card his grow-reveal">
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span>Extrato</span>
        </a>
    </nav>

    <section class="invite-section grow-reveal">
        <div class="invite-info">
            <h4>Expans√£o de Rede</h4>
            <p>Seu link de afiliado</p>
        </div>
        <button class="btn-copy" id="btn-copy-link">
            <i class="fa-solid fa-paper-plane"></i> Copiar
        </button>
    </section>

    <div class="banners-grid">
        <a href="investimentos.html" class="banner yield grow-reveal">
            <div class="banner-content">
                <h3>Rendimentos</h3>
                <p>Verificar ganhos hoje</p>
            </div>
            <div class="banner-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </a>
        <a href="planos.html" class="banner plans grow-reveal">
            <div class="banner-content">
                <h3>Novos Planos</h3>
                <p>Oportunidades VIP</p>
            </div>
            <div class="banner-icon"><i class="fa-solid fa-rocket"></i></div>
        </a>
    </div>

    <section class="transactions-area grow-reveal">
        <div class="area-title">
            <span>Movimenta√ß√µes Recentes</span>
            <i class="fa-solid fa-receipt" style="opacity: 0.3"></i>
        </div>
        <div class="transaction-list" id="recent-list"></div>
    </section>

    <nav class="bottom-nav">
        <a href="home.html" class="nav-link active">
            <i class="fa-solid fa-house"></i>
            <span>In√≠cio</span>
        </a>
        <a href="planos.html" class="nav-link">
            <i class="fa-solid fa-gem"></i>
            <span>Planos</span>
        </a>
        <a href="recompensas.html" class="nav-link">
            <i class="fa-solid fa-gift"></i>
            <span>B√¥nus</span>
        </a>
        <a href="indicacao.html" class="nav-link"> 
            <i class="fa-solid fa-users-viewfinder"></i>
            <span>Rede</span>
        </a>
        <a href="perfil.html" class="nav-link">
            <i class="fa-solid fa-circle-user"></i>
            <span>Perfil</span>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, orderBy, limit, getDocs, updateDoc, increment, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6sEp3R5HHZh9tIAqny5Ed8j2SY3WZhi0",
            authDomain: "capnex-c6447.firebaseapp.com",
            projectId: "capnex-c6447",
            storageBucket: "capnex-c6447.firebasestorage.app",
            messagingSenderId: "314835497580",
            appId: "1:314835497580:web:3f0b511d36e49c265bde49"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isVisible = true;
        let userDataCache = null;

        const CapNexAlert = {
            toast: (title, icon = 'success') => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 2500,
                    timerProgressBar: true,
                    background: '#1c1c1e',
                    color: '#fff',
                    iconColor: '#FF3B30',
                    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
                    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
                    customClass: { popup: 'capnex-swal-toast' }
                });
                Toast.fire({ icon: icon, title: title });
            }
        };

        function showWelcomeMessage(name) {
            if (!sessionStorage.getItem('welcomeShown')) {
                const contentHtml = `
                    <div class="welcome-header-img">
                        <i class="fa-solid fa-gem animate__animated animate__zoomIn animate__delay-1s"></i>
                    </div>
                    <div class="welcome-body">
                        <h2 class="welcome-title-text">Bem-vindo √† CapNex</h2>
                        <span class="welcome-subtitle">A plataforma de investimentos de alta performance.</span>
                        
                        <div class="info-grid">
                            <div class="info-row">
                                <div class="info-icon-box"><i class="fa-solid fa-wallet"></i></div>
                                <div class="info-text-box">
                                    <h5>Dep√≥sito Acess√≠vel</h5>
                                    <p>Comece a investir com recargas m√≠nimas a partir de <strong>R$ 30,00</strong>.</p>
                                </div>
                            </div>
                            <div class="info-row">
                                <div class="info-icon-box"><i class="fa-solid fa-chart-line"></i></div>
                                <div class="info-text-box">
                                    <h5>Rendimentos Agressivos</h5>
                                    <p>Lucros autom√°ticos de at√© <strong>20% ao dia</strong> creditados na sua carteira.</p>
                                </div>
                            </div>
                            <div class="info-row">
                                <div class="info-icon-box"><i class="fa-solid fa-network-wired"></i></div>
                                <div class="info-text-box">
                                    <h5>Comiss√£o de Rede</h5>
                                    <p>1¬™ Compra: <strong>15% - 1% - 1%</strong><br>
                                    Recompras: <strong>3% - 1% - 1%</strong></p>
                                </div>
                            </div>
                            <div class="info-row">
                                <div class="info-icon-box"><i class="fa-solid fa-money-bill-transfer"></i></div>
                                <div class="info-text-box">
                                    <h5>Saques Expresso</h5>
                                    <p>Retiradas r√°pidas com valor m√≠nimo de <strong>R$ 35,00</strong> via PIX.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                Swal.fire({
                    html: contentHtml,
                    showConfirmButton: true,
                    confirmButtonText: 'ACESSAR PAINEL',
                    buttonsStyling: false,
                    showCloseButton: true,
                    showClass: { popup: 'animate__animated animate__fadeInUp' },
                    hideClass: { popup: 'animate__animated animate__fadeOutDown' },
                    customClass: {
                        popup: 'capnex-swal-popup',
                        confirmButton: 'capnex-swal-confirm'
                    }
                }).then(() => {
                    sessionStorage.setItem('welcomeShown', 'true');
                });
            }
        }

        function triggerGrowReveal() {
            const items = document.querySelectorAll('.grow-reveal');
            items.forEach((item, index) => {
                setTimeout(() => { item.classList.add('active'); }, index * 80); 
            });
        }

        // --- CORRE√á√ÉO FINAL: CR√âDITO NO SALDO_LUCRO (SALDO DE SAQUE) ---
        async function processarGanhosAutomaticos(uid) {
            const agora = new Date();
            const vinteQuatroHoras = 24 * 60 * 60 * 1000;
            let totalCreditado = 0;

            try {
                // Processar Rendimentos de Planos Ativos
                const q = query(
                    collection(db, "user_investments"),
                    where("userId", "==", uid),
                    where("status", "==", "ativo")
                );

                const querySnapshot = await getDocs(q);

                for (const docSnap of querySnapshot.docs) {
                    const inv = docSnap.data();
                    const dataCompra = inv.dataCompra.toDate();
                    const milisPassados = agora.getTime() - dataCompra.getTime();
                    const ciclosQueDeveriamTerSidoPagos = Math.floor(milisPassados / vinteQuatroHoras);
                    const diasJaPagos = inv.diasPassados || 0;
                    const rendimentosPendentes = ciclosQueDeveriamTerSidoPagos - diasJaPagos;

                    if (rendimentosPendentes > 0 && diasJaPagos < inv.diasTotais) {
                        const ciclosEfetivosParaPagar = Math.min(rendimentosPendentes, inv.diasTotais - diasJaPagos);
                        const rendimentoDiario = parseFloat(inv.rendimentoDiario);
                        const rendimentoTotalPagar = rendimentoDiario * ciclosEfetivosParaPagar;
                        
                        const invRef = doc(db, "user_investments", docSnap.id);
                        const userRef = doc(db, "usuarios", uid);

                        await updateDoc(invRef, {
                            valorRecebido: increment(rendimentoTotalPagar),
                            diasPassados: increment(ciclosEfetivosParaPagar),
                            ultimoPagamento: Timestamp.now()
                        });

                        // SUCESSO: AQUI EST√Å A CORRE√á√ÉO - ENVIA PARA saldoLucro (SALDO DISPON√çVEL PARA SAQUE)
                        await updateDoc(userRef, {
                            saldoLucro: increment(rendimentoTotalPagar)
                        });

                        await addDoc(collection(db, "historico"), {
                            userId: uid,
                            valor: rendimentoTotalPagar,
                            tipo: "Rendimento Di√°rio",
                            descricao: `Plano: ${inv.titulo}`,
                            data: Timestamp.now(),
                            status: "CONCLUIDO"
                        });

                        totalCreditado += rendimentoTotalPagar;

                        if ((diasJaPagos + ciclosEfetivosParaPagar) >= inv.diasTotais) {
                            await updateDoc(invRef, { status: 'concluido' });
                        }
                    }
                }

                if (totalCreditado > 0) {
                    CapNexAlert.toast(`Ganhos creditados no Lucro: + R$ ${totalCreditado.toFixed(2)}`, 'success');
                }
            } catch (error) {
                console.error("Erro ao processar lucros:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                setupRealtimeSync(user.uid);
                setupRealtimeHistory(user.uid); 
                processarGanhosAutomaticos(user.uid);
                triggerGrowReveal();
            } else {
                window.location.href = "index.html";
            }
        });

        // SINCRONIZA√á√ÉO EM TEMPO REAL
        function setupRealtimeSync(uid) {
            onSnapshot(doc(db, "usuarios", uid), async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    userDataCache = data;
                    
                    const nameDisplay = data.nome || "Membro";
                    document.getElementById('user-display-name').innerText = nameDisplay;
                    showWelcomeMessage(nameDisplay);
                    
                    const hr = new Date().getHours();
                    let greet = hr < 12 ? "Bom dia ‚òÄÔ∏è" : hr < 18 ? "Boa tarde üå§Ô∏è" : "Boa noite üåô";
                    document.getElementById('txt-greeting').innerText = greet;

                    const parts = nameDisplay.split(" ");
                    document.getElementById('user-initials').innerText = parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : (parts[0] ? parts[0][0].toUpperCase() : "U");

                    renderBalances();

                    let inviteCode = data.inviteCode;
                    if (!inviteCode) {
                        inviteCode = uid.substring(0, 7).toUpperCase();
                        await updateDoc(doc(db, "usuarios", uid), { inviteCode: inviteCode });
                    }

                    const baseUrl = window.location.origin;
                    const refLink = `${baseUrl}/registro.html?ref=${inviteCode}`;

                    document.getElementById('btn-copy-link').onclick = () => {
                        navigator.clipboard.writeText(refLink).then(() => {
                            CapNexAlert.toast('Link de afiliado copiado!', 'success');
                        });
                    };
                }
            });
        }

        function renderBalances() {
            if (!userDataCache) return;
            const format = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const elBan = document.getElementById('val-bancario');
            const elLuc = document.getElementById('val-lucro'); 
            const icon = document.getElementById('btn-toggle-val');

            if (isVisible) {
                // MOSTRAR VALORES REAIS
                elBan.innerText = format(userDataCache.saldo); // Saldo de dep√≥sito
                elLuc.innerText = format(userDataCache.saldoLucro); // Saldo de Lucros/Ganhos
                icon.className = "fa-regular fa-eye eye-btn";
            } else {
                // OCULTAR VALORES
                elBan.innerText = "R$ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                elLuc.innerText = "R$ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                icon.className = "fa-regular fa-eye-slash eye-btn";
            }
        }

        document.getElementById('btn-toggle-val').onclick = () => {
            isVisible = !isVisible;
            renderBalances();
        };

        function setupRealtimeHistory(uid) {
            const listContainer = document.getElementById('recent-list');
            const q = query(
                collection(db, "historico"),
                where("userId", "==", uid),
                orderBy("data", "desc"),
                limit(4)
            );

            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = ""; 

                if (snapshot.empty) {
                    listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#555; font-size:0.8rem;">Nenhuma transa√ß√£o encontrada.</div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const t = doc.data();
                    const date = t.data ? t.data.toDate().toLocaleDateString('pt-BR') : '--/--';
                    const valorNum = parseFloat(t.valor) || 0;
                    
                    const tipo = (t.tipo || "").toLowerCase();
                    // L√≥gica visual: Comiss√µes e Rendimentos aparecem como positivo (Verde)
                    const isPositive = (tipo.includes("rendimento") || tipo.includes("b√¥nus") || tipo.includes("comiss√£o") || tipo.includes("dep√≥sito"));
                    
                    listContainer.innerHTML += `
                        <div class="t-item animate__animated animate__fadeIn">
                            <div class="t-info">
                                <h5>${t.tipo || 'Opera√ß√£o'}</h5>
                                <small>${date} ‚Ä¢ ${t.status || 'CONCLUIDO'}</small>
                            </div>
                            <div class="t-amount" style="color: ${isPositive ? 'var(--success)' : 'var(--danger)'}">
                                ${isPositive ? '+' : '-'} R$ ${Math.abs(valorNum).toFixed(2).replace('.', ',')}
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                console.error("Erro no Listener do Hist√≥rico:", error);
            });
        }
    </script>
</body>
</html>
