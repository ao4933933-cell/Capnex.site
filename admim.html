<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master C-Panel | CapNex Elite v2.5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --bg-black: #020203;
            --card-bg: #0d0d0f;
            --primary-red: #FF3B30;
            --dark-red: #8B0000;
            --accent-gold: #FFD60A;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.07);
            --text-main: #FFFFFF;
            --text-dim: #8E8E93;
            --accent-green: #34C759;
            --error-red: #FF453A;
            --staff-blue: #007AFF;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            outline: none !important; -webkit-tap-highlight-color: transparent;
        }

        body { 
            background: var(--bg-black); 
            color: var(--text-main); 
            padding: 20px; 
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 59, 48, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(255, 59, 48, 0.03) 0%, transparent 50%);
        }

        .container { max-width: 1300px; margin: 0 auto; }

        .admin-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 40px; padding: 30px; 
            background: var(--card-bg); border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .logo-area h1 { font-size: 1.6rem; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; }
        .logo-area h1 span { color: var(--primary-red); }
        .logo-area p { font-size: 0.65rem; color: var(--text-dim); letter-spacing: 3px; font-weight: 700; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg); padding: 30px; border-radius: 28px;
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary-red); box-shadow: 0 15px 30px rgba(255,59,48,0.1); }
        .stat-card i { font-size: 1.5rem; color: var(--primary-red); margin-bottom: 20px; display: block; }
        .stat-card h2 { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; }
        .stat-card p { font-size: 0.75rem; color: var(--text-dim); font-weight: 600; text-transform: uppercase; }

        .admin-section {
            background: var(--card-bg); border-radius: 32px; border: 1px solid var(--glass-border);
            padding: 35px; margin-bottom: 30px;
        }

        .section-title {
            font-size: 1rem; color: #fff; margin-bottom: 30px;
            display: flex; align-items: center; gap: 15px; font-weight: 800;
        }
        .section-title i { color: var(--primary-red); font-size: 1.2rem; }
        .section-title.gold i { color: var(--accent-gold); }

        .input-group { display: flex; gap: 15px; margin-bottom: 25px; }
        input, textarea {
            flex: 1; padding: 20px 25px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 18px; color: white; transition: 0.3s; font-size: 0.95rem; font-weight: 500;
        }
        input:focus { border-color: var(--primary-red); background: rgba(255,255,255,0.05); }

        .btn {
            padding: 18px 28px; border: none; border-radius: 18px; font-weight: 800;
            cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px;
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px;
        }
        .btn-primary { background: var(--primary-red); color: #fff; box-shadow: 0 10px 20px rgba(255,59,48,0.2); }
        .btn-outline { background: transparent; color: #fff; border: 1px solid var(--glass-border); }
        .btn-green { background: var(--accent-green); color: #000; }
        .btn-gold { background: var(--accent-gold); color: #000; }
        .btn-danger { background: rgba(255, 69, 58, 0.1); color: var(--error-red); border: 1px solid rgba(255, 69, 58, 0.2); }

        #user-result {
            display: none; background: rgba(255, 255, 255, 0.01); padding: 40px; border-radius: 30px;
            border: 1px solid var(--glass-border); margin-top: 25px;
        }

        .user-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 30px 0; }
        .user-data-box { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.03); }
        .user-data-box label { display: block; font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; font-weight: 800; margin-bottom: 10px; }
        .user-data-box span { font-size: 1.1rem; font-weight: 800; color: #fff; }
        .user-data-box.highlight { border-color: rgba(255, 59, 48, 0.3); background: rgba(255, 59, 48, 0.02); }

        .hired-row td { 
            background: rgba(255, 214, 10, 0.08) !important; 
            border-top: 1px solid rgba(255, 214, 10, 0.3) !important;
            border-bottom: 1px solid rgba(255, 214, 10, 0.3) !important;
        }
        .hired-row td:first-child { border-left: 1px solid rgba(255, 214, 10, 0.3) !important; }
        .hired-row td:last-child { border-right: 1px solid rgba(255, 214, 10, 0.3) !important; }
        
        .hired-pulse {
            animation: hiredPulseAnim 2s infinite;
            box-shadow: 0 0 15px rgba(255, 214, 10, 0.4);
        }
        @keyframes hiredPulseAnim {
            0% { box-shadow: 0 0 0 0 rgba(255, 214, 10, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(255, 214, 10, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 214, 10, 0); }
        }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        th { text-align: left; padding: 0 20px; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 22px 20px; background: rgba(255,255,255,0.02); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); transition: 0.3s; }
        td:first-child { border-left: 1px solid var(--glass-border); border-radius: 20px 0 0 20px; }
        td:last-child { border-right: 1px solid var(--glass-border); border-radius: 0 20px 20px 0; }

        .status-badge { padding: 8px 16px; border-radius: 12px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; }
        .status-active { background: rgba(52, 199, 89, 0.1); color: var(--accent-green); }
        .status-blocked { background: rgba(255, 69, 58, 0.1); color: var(--error-red); }
        .status-hired { background: var(--accent-gold); color: #000; font-weight: 900; }

        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
        }

        .ref-card { 
            background: rgba(255, 255, 255, 0.02); padding: 20px; border-radius: 20px; 
            margin-top: 20px; border: 1px solid var(--glass-border); font-size: 0.85rem; color: var(--text-dim);
        }

        .control-panel { width: 340px; background: rgba(255,255,255,0.02); padding: 30px; border-radius: 28px; border: 1px solid var(--glass-border); }

        @media (max-width: 768px) {
            .input-group { flex-direction: column; }
            .control-panel { width: 100%; }
            .admin-header { flex-direction: column; text-align: center; gap: 20px; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="animate__animated animate__pulse animate__infinite">
            <i class="fas fa-shield-halved" style="font-size: 4rem; color: var(--primary-red);"></i>
        </div>
        <p style="margin-top:25px; font-weight: 800; letter-spacing: 5px; color: #fff; text-transform: uppercase; font-size: 0.7rem;">CapNex Core Security</p>
    </div>

    <div id="access-denied" style="display:none; text-align: center; margin-top: 20vh;">
        <i class="fas fa-lock" style="font-size: 5rem; color: var(--error-red); margin-bottom: 30px;"></i>
        <h1 style="font-size: 2rem; font-weight: 900;">ACESSO RESTRITO</h1>
        <p style="color: var(--text-dim); margin-top: 10px; font-weight: 500;">Credenciais de nível Master não detectadas.</p><br>
        <a href="index.html" class="btn btn-primary">RETORNAR</a>
    </div>

    <div id="admin-panel" class="container" style="display:none;">
        <div class="admin-header">
            <div class="logo-area">
                <h1><span>CAP</span>NEX COMMAND</h1>
                <p>TERMINAL MASTER • V2.5 STAFF</p>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="text-align: right;">
                    <span id="admin-mail" style="font-size: 0.75rem; font-weight: 800; color: #fff; display: block;"></span>
                    <span style="font-size: 0.6rem; color: var(--accent-green); font-weight: 800;">SISTEMA ONLINE</span>
                </div>
                <button class="btn btn-danger" style="padding: 12px 20px;" onclick="auth.signOut()">LOGOUT</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-chart-line"></i>
                <h2 id="total-custodia">R$ 0,00</h2>
                <p>Volume em Custódia</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock-rotate-left"></i>
                <h2 id="total-pendente">R$ 0,00</h2>
                <p>Saques Pendentes</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-user-group"></i>
                <h2 id="total-users">0</h2>
                <p>Usuários Registrados</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-piggy-bank"></i>
                <h2 id="total-lucro-global">R$ 0,00</h2>
                <p>Total de Lucros Pagos</p>
            </div>
        </div>

        <div class="admin-section" style="border: 1px solid rgba(255, 214, 10, 0.3); background: rgba(255, 214, 10, 0.02);">
            <div class="section-title gold"><i class="fas fa-crown"></i> Contratados (Staff Elite)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Identificação</th>
                            <th>Total Sacado</th>
                            <th>Saldo Lucro</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="lista-contratados">
                        <tr><td colspan="4" style="text-align:center; color:var(--text-dim);">Carregando elite...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-title"><i class="fas fa-user-gear"></i> Gestão de Investidores & Staff</div>
            <div class="input-group">
                <input type="email" id="search-email" placeholder="E-mail do usuário...">
                <button class="btn btn-primary" id="btn-search"><i class="fas fa-search"></i> INVESTIGAR</button>
            </div>

            <div id="user-result" class="animate__animated animate__fadeIn">
                <div id="user-result-container" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 30px; padding: 20px; border-radius: 25px; transition: 0.5s;">
                    <div style="flex: 1; min-width: 300px;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
                            <div id="res-avatar" style="width: 70px; height: 70px; background: var(--primary-red); border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; transition: 0.5s;">
                                <span id="res-char">-</span>
                            </div>
                            <div>
                                <h3 id="res-nome" style="font-size: 1.8rem; font-weight: 800;">-</h3>
                                <span id="res-status" class="status-badge"></span>
                            </div>
                        </div>

                        <div class="user-grid">
                            <div class="user-data-box" style="border-color: var(--staff-blue);">
                                <label><i class="fas fa-id-badge"></i> User UID</label>
                                <span id="res-uid-display" style="font-family: monospace; font-size: 0.85rem; color: var(--staff-blue);">N/A</span>
                            </div>
                            <div class="user-data-box" style="border-color: var(--accent-gold);">
                                <label><i class="fas fa-microchip"></i> ID Investimento</label>
                                <span id="res-inv-id" style="font-family: monospace; font-size: 0.85rem; color: var(--accent-gold);">Nenhum Ativo</span>
                            </div>
                            <div class="user-data-box">
                                <label>Saldo Bancário</label>
                                <span id="res-saldo-compra">R$ 0,00</span>
                            </div>
                            <div class="user-data-box highlight">
                                <label>Saldo de Lucro</label>
                                <span id="res-saldo-saque">R$ 0,00</span>
                            </div>
                            <div class="user-data-box">
                                <label>Histórico de Depósitos</label>
                                <span id="res-total-dep" style="color: var(--accent-green);">R$ 0,00</span>
                            </div>
                            <div class="user-data-box">
                                <label>Total Retirado</label>
                                <span id="res-total-sac">R$ 0,00</span>
                            </div>
                            <div class="user-data-box">
                                <label>Ativos em Operação</label>
                                <span id="res-planos">0</span>
                            </div>
                            <div class="user-data-box">
                                <label>Time de Afiliados</label>
                                <span id="res-rede">0</span>
                            </div>
                        </div>
                        <div id="res-upline" class="ref-card"><i class="fas fa-link" style="margin-right: 10px;"></i> Upline: -</div>
                    </div>

                    <div class="control-panel" id="res-control-panel">
                        <label style="font-size: 0.7rem; font-weight: 900; color: var(--text-dim); display: block; margin-bottom: 20px; text-transform: uppercase;">Controles de Operador</label>
                        <input type="number" id="mod-valor" placeholder="Valor R$" style="width: 100%; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-green" style="width: 100%; justify-content: center;" id="btn-add-compra">BANCÁRIO</button>
                            <button class="btn btn-primary" style="width: 100%; justify-content: center;" id="btn-add-saque">LUCRO</button>
                        </div>
                        <button class="btn btn-gold" style="width: 100%; margin-bottom: 10px; justify-content: center;" id="btn-set-hired"><i class="fas fa-star"></i> DEFINIR CONTRATADO</button>
                        <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px; justify-content: center;" id="btn-reset-pass"><i class="fas fa-envelope"></i> RESETAR SENHA</button>
                        <button class="btn btn-danger" style="width: 100%; justify-content: center;" id="btn-ban"><i class="fas fa-user-slash"></i> BANIR / ATIVAR</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-title"><i class="fas fa-microchip"></i> Parâmetros de Sistema</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                <div class="user-data-box" style="background: rgba(255,255,255,0.01);">
                    <label>Informativo Geral (Dashboard)</label>
                    <textarea id="aviso-text" rows="3" placeholder="Digite o aviso que aparecerá para todos os usuários..." style="width: 100%; margin: 15px 0;"></textarea>
                    <button class="btn btn-primary" id="btn-set-aviso" style="width: 100%;">ATUALIZAR BROADCAST</button>
                </div>
                <div class="user-data-box" style="background: rgba(255,255,255,0.01);">
                    <label>Módulo de Correção de Fluxo</label>
                    <p style="font-size: 0.75rem; color: var(--text-dim); margin: 15px 0; line-height: 1.5;">Este comando move comissões pendentes (L1, L2, L3) do saldo de compra para o saldo de saque em todos os registros.</p>
                    <button class="btn btn-danger" id="btn-fix-global" style="width: 100%;"><i class="fas fa-bolt-lightning"></i> EXECUTAR CORREÇÃO</button>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-title"><i class="fas fa-wallet"></i> Solicitações de Saque</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Investidor</th>
                            <th>Chave PIX</th>
                            <th>Valor Líquido</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lista-saques"></tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-title"><i class="fas fa-users"></i> Registros de Operadores Recentes</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Identificação</th>
                            <th>Patrimônio</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="lista-recentes"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, query, where, updateDoc, setDoc, orderBy, limit, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6sEp3R5HHZh9tIAqny5Ed8j2SY3WZhi0",
            authDomain: "capnex-c6447.firebaseapp.com",
            projectId: "capnex-c6447",
            storageBucket: "capnex-c6447.firebasestorage.app",
            messagingSenderId: "314835497580",
            appId: "1:314835497580:web:3f0b511d36e49c265bde49"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const MASTER_ADMIN_UID = "QKXNWGu6uWOmJr3XhWnAdKdJH8c2";
        const MASTER_ADMINS_EMAILS = ["ao981017448@gmail.com", "lopezzedwardd6@gmail.com"];
        const WEBHOOK_PAY = "https://hook.us2.make.com/1i8cv3gfh95c5oyhw8h3yanjxgqchq7r";

        let currentUserId = null;
        let currentUserStatus = "ativo";

        onAuthStateChanged(auth, async (user) => {
            if (user && (user.uid === MASTER_ADMIN_UID || MASTER_ADMINS_EMAILS.includes(user.email.toLowerCase()))) {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('admin-mail').innerText = user.email.toUpperCase();
                loadDashboard();
            } else {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').style.display = 'block';
            }
        });

        async function loadDashboard() {
            try {
                const uSnap = await getDocs(collection(db, "usuarios"));
                let cTotal = 0, lTotal = 0;
                uSnap.forEach(d => {
                    const data = d.data();
                    cTotal += (data.saldo || 0);
                    lTotal += (data.saldoLucro || 0);
                });

                document.getElementById('total-custodia').innerText = `R$ ${cTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-lucro-global').innerText = `R$ ${lTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-users').innerText = uSnap.size;

                const sSnap = await getDocs(query(collection(db, "saques"), where("status", "==", "pendente")));
                let sTotal = 0;
                sSnap.forEach(d => sTotal += (d.data().liquido || d.data().valorReceber || 0));
                document.getElementById('total-pendente').innerText = `R$ ${sTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                renderSaques();
                renderRecentes();
                renderContratados();
            } catch (error) {
                console.error("Erro ao carregar dashboard:", error);
            }
        }

        async function renderContratados() {
            const q = query(collection(db, "usuarios"), where("status", "==", "contratado"));
            const snap = await getDocs(q);
            const body = document.getElementById('lista-contratados');
            body.innerHTML = "";

            if(snap.empty) {
                body.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Nenhum contratado no sistema.</td></tr>";
                return;
            }

            snap.forEach(d => {
                const u = d.data();
                body.innerHTML += `
                    <tr class="hired-row">
                        <td><b style="color:var(--accent-gold);">${u.email}</b><br><small>${u.nome}</small></td>
                        <td style="color:var(--accent-green); font-weight:700;">R$ ${(u.totalSacado || 0).toFixed(2)}</td>
                        <td>R$ ${(u.saldoLucro || 0).toFixed(2)}</td>
                        <td><button class="btn btn-gold" style="padding:8px 12px; font-size:0.6rem;" onclick="window.setSearch('${u.email}')">GERENCIAR</button></td>
                    </tr>
                `;
            });
        }

        document.getElementById('btn-search').addEventListener('click', async () => {
            const email = document.getElementById('search-email').value.trim();
            if(!email) return;

            const q = query(collection(db, "usuarios"), where("email", "==", email));
            const snap = await getDocs(q);

            if(snap.empty) {
                Swal.fire({icon: 'error', title: 'Usuário Inexistente', background: '#0d0d0f', color: '#fff'});
                return;
            }

            const d = snap.docs[0].data();
            currentUserId = snap.docs[0].id;
            currentUserStatus = d.status || "ativo";

            // EXIBIÇÃO DO UID DO USUÁRIO
            document.getElementById('res-uid-display').innerText = currentUserId;

            const depSnap = await getDocs(query(collection(db, "depositos"), where("userId", "==", currentUserId), where("status", "==", "aprovado")));
            let totalRealDep = 0;
            depSnap.forEach(docDep => totalRealDep += (docDep.data().valor || 0));

            document.getElementById('res-char').innerText = (d.nome || "U").charAt(0).toUpperCase();
            document.getElementById('res-nome').innerText = d.nome || "N/A";
            document.getElementById('res-saldo-compra').innerText = `R$ ${(d.saldo || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('res-saldo-saque').innerText = `R$ ${(d.saldoLucro || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('res-total-dep').innerText = `R$ ${totalRealDep.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('res-total-sac').innerText = `R$ ${(d.totalSacado || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const qRede = query(collection(db, "usuarios"), where("indicadoPor", "==", currentUserId));
            const redSnap = await getDocs(qRede);
            document.getElementById('res-rede').innerText = redSnap.size;

            // BUSCA E EXIBIÇÃO DO ID DO INVESTIMENTO ATIVO
            const qPlanos = query(collection(db, "user_investments"), where("userId", "==", currentUserId), where("status", "==", "ativo"));
            const planSnap = await getDocs(qPlanos);
            document.getElementById('res-planos').innerText = planSnap.size;
            
            if(!planSnap.empty) {
                document.getElementById('res-inv-id').innerText = planSnap.docs[0].id;
            } else {
                document.getElementById('res-inv-id').innerText = "Nenhum Ativo";
            }

            if(d.indicadoPor) {
                const upSnap = await getDoc(doc(db, "usuarios", d.indicadoPor));
                document.getElementById('res-upline').innerHTML = upSnap.exists() ? `<i class="fas fa-link"></i> Indicado por: <b>${upSnap.data().nome}</b>` : "Upline não encontrado";
            } else {
                document.getElementById('res-upline').innerHTML = `<i class="fas fa-shield-halved"></i> Registro Direto (Sem Afiliado)`;
            }

            const badge = document.getElementById('res-status');
            const avatar = document.getElementById('res-avatar');
            const resultBox = document.getElementById('user-result-container');
            
            resultBox.style.background = "rgba(255, 255, 255, 0.01)";
            resultBox.style.border = "none";
            avatar.classList.remove('hired-pulse');

            if(currentUserStatus === 'contratado'){
                badge.innerText = "CONTRATADO";
                badge.className = "status-badge status-hired";
                avatar.style.background = "var(--accent-gold)";
                avatar.style.color = "#000";
                avatar.classList.add('hired-pulse');
                resultBox.style.background = "rgba(255, 214, 10, 0.05)";
                resultBox.style.border = "1px solid rgba(255, 214, 10, 0.2)";
            } else {
                badge.innerText = currentUserStatus;
                badge.className = `status-badge status-${currentUserStatus === 'ativo' ? 'active' : 'blocked'}`;
                avatar.style.background = "var(--primary-red)";
                avatar.style.color = "#fff";
            }
            
            document.getElementById('user-result').style.display = 'block';
        });

        document.getElementById('btn-add-compra').onclick = () => modSaldo("saldo");
        document.getElementById('btn-add-saque').onclick = () => modSaldo("saldoLucro");

        async function modSaldo(campo) {
            const val = parseFloat(document.getElementById('mod-valor').value);
            if(!val || !currentUserId) return;
            try {
                await updateDoc(doc(db, "usuarios", currentUserId), { [campo]: increment(val) });
                Swal.fire({icon: 'success', title: 'Saldo Ajustado', background: '#0d0d0f', color: '#fff'});
                document.getElementById('btn-search').click();
                loadDashboard();
            } catch(e) {
                Swal.fire({icon: 'error', title: 'Erro de Permissão', text: 'Verifique se você é o admin master nas Regras do Firebase.', background: '#0d0d0f', color: '#fff'});
            }
        }

        document.getElementById('btn-set-hired').onclick = async () => {
            const novoStatus = currentUserStatus === "contratado" ? "ativo" : "contratado";
            try {
                await updateDoc(doc(db, "usuarios", currentUserId), { status: novoStatus });
                Swal.fire({icon: 'info', title: 'Status de Staff Atualizado', background: '#0d0d0f', color: '#fff'});
                document.getElementById('btn-search').click();
                loadDashboard();
            } catch(e) {
                Swal.fire({icon: 'error', title: 'Acesso Negado', text: 'Sua conta não tem permissão para alterar status nas Regras do Firebase.', background: '#0d0d0f', color: '#fff'});
            }
        };

        document.getElementById('btn-ban').onclick = async () => {
            const novoStatus = currentUserStatus === "bloqueado" ? "ativo" : "bloqueado";
            try {
                await updateDoc(doc(db, "usuarios", currentUserId), { status: novoStatus });
                document.getElementById('btn-search').click();
                loadDashboard();
            } catch(e) {
                Swal.fire('Erro', 'Sem permissão para banir.', 'error');
            }
        };

        document.getElementById('btn-reset-pass').onclick = async () => {
            const mail = document.getElementById('search-email').value;
            if(!mail) return;
            await sendPasswordResetEmail(auth, mail);
            Swal.fire('Solicitação Enviada', 'E-mail de redefinição encaminhado.', 'success');
        };

        async function renderSaques() {
            const q = query(collection(db, "saques"), where("status", "==", "pendente"));
            const snap = await getDocs(q);
            const body = document.getElementById('lista-saques');
            body.innerHTML = "";

            if (snap.empty) {
                body.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Nenhum saque pendente</td></tr>";
                return;
            }

            snap.forEach(d => {
                const s = d.data();
                const nomeCliente = s.cliente || "Não informado";
                const chavePix = s.pix || "N/A";
                const valorLiq = Number(s.liquido || 0);
                
                let dataFormatada = "N/A";
                if(s.data && typeof s.data.toDate === 'function') {
                    dataFormatada = s.data.toDate().toLocaleString('pt-BR'); 
                } else if(s.data) {
                    dataFormatada = String(s.data);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-size:0.8rem;">${dataFormatada}</td>
                    <td><b style="font-size:0.8rem;">${nomeCliente}</b></td>
                    <td style="color:var(--accent-gold); font-size:0.8rem;">${chavePix}</td>
                    <td style="color:var(--accent-green); font-weight:800;">R$ ${valorLiq.toFixed(2)}</td>
                    <td><button class="btn btn-green btn-aprovar" style="padding:8px 15px;">APROVAR</button></td>
                `;

                tr.querySelector('.btn-aprovar').onclick = () => window.processarSaque(d.id, s);
                body.appendChild(tr);
            });
        }

        window.processarSaque = async (id, dados) => {
            let valorRaw = String(dados.liquido || 0);
            let valorLimpo = valorRaw.replace('R$', '').replace(/\s/g, '').replace(',', '.');
            const valorFinal = parseFloat(valorLimpo);

            if (isNaN(valorFinal)) {
                Swal.fire('Erro', 'Valor inválido.', 'error');
                return;
            }

            const pixFinal = String(dados.pix || "").trim();
            const tipoFinal = String(dados.tipo || "cpf").toLowerCase().trim();

            const conf = await Swal.fire({
                title: 'Confirmar Pagamento?',
                text: `Enviar R$ ${valorFinal.toFixed(2)} para ${dados.cliente}?`,
                showCancelButton: true,
                background: '#0d0d0f',
                color: '#fff',
                confirmButtonColor: '#34C759',
                confirmButtonText: 'SIM, ENVIAR AGORA'
            });

            if(!conf.isConfirmed) return;

            Swal.fire({ 
                title: 'Enviando Pagamento...', 
                text: 'Comunicação direta com a API Evopay via Webhook',
                allowOutsideClick: false, 
                didOpen: () => Swal.showLoading() 
            });

            try {
                const res = await fetch(WEBHOOK_PAY, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        amount: valorFinal,
                        pixKey: pixFinal,
                        pixType: tipoFinal,
                        callbackUrl: "https://capnex-c6447.web.app"
                    })
                });

                if(res.ok) {
                    await updateDoc(doc(db, "saques", id), { 
                        status: "concluido", 
                        pagoEm: serverTimestamp() 
                    });
                    
                    if (dados.uid) {
                        const qU = query(collection(db, "usuarios"), where("uid", "==", dados.uid));
                        const uS = await getDocs(qU);
                        if(!uS.empty) {
                            await updateDoc(doc(db, "usuarios", uS.docs[0].id), { 
                                totalSacado: increment(valorFinal) 
                            });
                        }
                    }

                    Swal.fire('Sucesso!', 'Pagamento aprovado e enviado!', 'success');
                    loadDashboard();
                } else {
                    const erroTxt = await res.text();
                    Swal.fire('Erro na Transação', `A API Evopay recusou: ${erroTxt}`, 'error');
                }
            } catch(e) { 
                console.error(e);
                Swal.fire('Falha na Rede', 'Não foi possível contatar o servidor de pagamentos.', 'error'); 
            }
        };

        async function renderRecentes() {
            const q = query(collection(db, "usuarios"), orderBy("dataCriacao", "desc"), limit(15));
            const snap = await getDocs(q);
            const body = document.getElementById('lista-recentes');
            body.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                let statusClass = "active";
                let rowClass = "";
                
                if(u.status === "bloqueado") statusClass = "blocked";
                if(u.status === "contratado") {
                    statusClass = "hired";
                    rowClass = "hired-row";
                }

                body.innerHTML += `
                    <tr class="${rowClass}">
                        <td><span class="status-badge status-${statusClass}">${u.status || 'ativo'}</span></td>
                        <td><b style="font-size:0.8rem;">${u.email}</b><br><small style="color:var(--text-dim)">${u.nome}</small></td>
                        <td style="font-weight:700;">R$ ${((u.saldo || 0) + (u.saldoLucro || 0)).toFixed(2)}</td>
                        <td><button class="btn btn-outline" style="padding:8px 12px; border-color: ${u.status === 'contratado' ? 'var(--accent-gold)' : ''}" onclick="window.setSearch('${u.email}')">GERIR</button></td>
                    </tr>
                `;
            });
        }

        window.setSearch = (email) => {
            document.getElementById('search-email').value = email;
            document.getElementById('btn-search').click();
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        document.getElementById('btn-set-aviso').onclick = async () => {
            const texto = document.getElementById('aviso-text').value;
            await setDoc(doc(db, "configuracoes", "aviso_global"), {texto, data: serverTimestamp()});
            Swal.fire('Broadcast Atualizado', 'A mensagem já está visível para todos.', 'success');
        };

        document.getElementById('btn-fix-global').onclick = async () => {
            const conf = await Swal.fire({
                title: 'Limpeza de Fluxo?',
                text: 'Esta ação é irreversível e afetará todos os usuários.',
                icon: 'warning',
                showCancelButton: true,
                background: '#0d0d0f',
                color: '#fff'
            });
            if(!conf.isConfirmed) return;

            const uSnap = await getDocs(collection(db, "usuarios"));
            uSnap.forEach(async (uDoc) => {
                const u = uDoc.data();
                const totalComissao = (u.totalGanhosL1 || 0) + (u.totalGanhosL2 || 0) + (u.totalGanhosL3 || 0);
                if(totalComissao > 0) {
                    await updateDoc(doc(db, "usuarios", uDoc.id), {
                        saldo: increment(-totalComissao),
                        saldoLucro: increment(totalComissao)
                    });
                }
            });
            Swal.fire('Processo Concluído', 'Comissões migradas para saldo de saque.', 'success');
            loadDashboard();
        };

    </script>
</body>
</html>
